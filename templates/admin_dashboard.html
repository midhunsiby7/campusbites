<!-- admin_dashboard.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Dashboard - CampusBites</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body class="admin-body">
  <header class="admin-header">
    <h1 class="admin-title">Admin Dashboard</h1>
    <nav class="admin-nav">
      <a href="{{ url_for('admin_foods') }}" class="admin-nav-btn">Manage Foods</a>
      <a href="{{ url_for('admin_todays_menu') }}" class="admin-nav-btn">Menu</a>
      <a href="{{ url_for('scan_qr') }}" class="admin-nav-btn">Scan QR</a>
      <button class="admin-nav-btn" onclick="openUncollectedTokensPopup()">Uncollected Tokens</button>
      <form action="{{ url_for('admin_logout') }}" method="POST" class="logout-form">
        <button type="submit" class="logout-btn">Logout</button>
      </form>
    </nav>
  </header>

  <main class="admin-main">
    <form method="get" action="/admin/dashboard" class="admin-filter-form">
      <div class="filter-row">
        <select name="status" id="statusFilter">
          <option value="all" {% if selected_status == 'all' %}selected{% endif %}>All</option>
          <option value="confirmed" {% if selected_status == 'confirmed' %}selected{% endif %}>Confirmed</option>
          <option value="delivered" {% if selected_status == 'delivered' %}selected{% endif %}>Delivered</option>
        </select>
        <select name="sort" id="sortSelect">
          <option value="newest" {% if selected_sort == 'newest' %}selected{% endif %}>Newest First</option>
          <option value="oldest" {% if selected_sort == 'oldest' %}selected{% endif %}>Oldest First</option>
        </select>
      </div>
      <div class="filter-row">
        <input type="text" name="search" id="searchInput" placeholder="Search by name or token...">
        <!-- Apply button removed -->
      </div>
    </form>

    <div class="orders-wrapper">
      {% for order in orders %}
      <div class="order-card" data-id="{{ order.id }}" data-status="{{ order.status }}">
        <div class="order-header">
          <div>
            <small>Order ID: {{ order.id }}</small>
          </div>
          {% if order.status == 'confirmed' and order.payment_status == 'paid' %}
            <span class="badge status-badge">Confirmed and Paid</span>
          {% else %}
            <span class="badge status-badge">{{ order.status|capitalize }}</span>
          {% endif %}
        </div>
        <div class="order-body">
          <p><strong>Token No:</strong> {{ order.token_number }}</p>
          <p><strong>User:</strong> {{ order.user_name }}</p>
          <p><strong>Total:</strong> â‚¹{{ order.total }}</p>
          <p><strong>Time:</strong> {{ order.created_at.strftime('%d %b, %I:%M %p') if order.created_at else 'N/A' }}</p>
          {% if order.time_ago %}<p class="ago">({{ order.time_ago }})</p>{% endif %}
        </div>
        <div class="order-actions">
          <a href="{{ url_for('admin_view_order', order_id=order.id) }}" class="btn">View</a>
          {% if order.status == 'paid' %}
            <form action="{{ url_for('admin_confirm_order', order_id=order.id) }}" method="post">
              <button type="submit" class="action-btn confirm">Confirm</button>
            </form>
          {% elif order.status == 'confirmed' %}
            <form action="{{ url_for('mark_delivered', order_id=order.id) }}" method="post">
              <button type="submit" class="action-btn deliver">Deliver</button>
            </form>
          {% endif %}
        </div>
      </div>
      {% endfor %}
    </div>
  </main>

  <script>
const searchInput = document.getElementById("searchInput");
const sortSelect = document.getElementById("sortSelect");
const statusFilter = document.getElementById("statusFilter");

if (searchInput) searchInput.addEventListener("input", filterTable);
if (sortSelect) sortSelect.addEventListener("change", applyFilters);
if (statusFilter) statusFilter.addEventListener("change", applyFilters);

function filterTable() {
  const query = searchInput.value.trim().toLowerCase();
  const status = statusFilter.value;
  const sortOrder = sortSelect.value;
  const cards = Array.from(document.querySelectorAll(".order-card"));
  let visibleCount = 0;

  cards.forEach(card => {
    const tokenNum = card.querySelector(".order-header strong")?.innerText.replace("#", "").trim().toLowerCase() || "";
    const userName = card.querySelector(".order-body p:nth-child(1)")?.innerText.split(":")[1]?.trim().toLowerCase() || "";

    const matchesQuery = !query || tokenNum.includes(query) || userName.includes(query);
    const matchesStatus = status === "all" || card.dataset.status === status;

    if (matchesQuery && matchesStatus) {
      card.style.display = "flex";
      visibleCount++;
    } else {
      card.style.display = "none";
    }
  });

  // Sort visible cards
  const wrapper = document.querySelector(".orders-wrapper");
  const visibleCards = cards.filter(c => c.style.display !== "none");
  visibleCards.sort((a, b) => {
    const idA = parseInt(a.dataset.id);
    const idB = parseInt(b.dataset.id);
    return sortOrder === "newest" ? idB - idA : idA - idB;
  });
  wrapper.innerHTML = "";
  visibleCards.forEach(c => wrapper.appendChild(c));

  // Show "no results" message if nothing found
  if (visibleCount === 0) {
    wrapper.innerHTML = `<p style="text-align:center; color:#777; margin-top:20px;">No matching orders found</p>`;
  }
  if (searchInput) {
  ["input", "keyup", "change"].forEach(evt => {
    searchInput.addEventListener(evt, () => {
      filterTable();
    });
  });
}

}

function applyFilters() {
  filterTable();
}

let latestOrderId = parseInt(document.querySelector('.order-card')?.dataset.id || '0');

async function liveUpdateDashboard() {
  try {
    const response = await fetch(window.location.href);
    const html = await response.text();
    const newDoc = new DOMParser().parseFromString(html, 'text/html');
    const newCards = newDoc.querySelector('.orders-wrapper');

    if (newCards && newCards.children.length > 0) {
      const newFirstOrder = newCards.querySelector('.order-card');
      const newFirstOrderId = parseInt(newFirstOrder?.dataset.id || '0');
      if (newFirstOrderId > latestOrderId) {
        latestOrderId = newFirstOrderId;
      }
      document.querySelector('.orders-wrapper').innerHTML = newCards.innerHTML;
    }

    // Re-apply current filters instantly after refresh
    filterTable();

  } catch (err) {
    console.error("Live update failed", err);
  }
}

document.addEventListener('DOMContentLoaded', () => {
  filterTable();
  setInterval(liveUpdateDashboard, 5000);
});

// Preserve scroll position
window.addEventListener("beforeunload", function () {
  sessionStorage.setItem("scrollPos", window.scrollY);
});
window.addEventListener("load", function () {
  const scrollPos = sessionStorage.getItem("scrollPos");
  if (scrollPos !== null) {
    window.scrollTo(0, parseInt(scrollPos));
    sessionStorage.removeItem("scrollPos");
  }
});
</script>

</body>
</html>
