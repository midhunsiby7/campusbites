<!-- orders.html -->
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Your Orders</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body class="orders-page">
  <div class="order-container">
    <div class="home-body has-bottom-nav">
      <h2>Your Orders</h2>

      <!-- Today's Orders -->
      <div class="order-section">
        <h3>Today's Orders</h3>
        {% if today_orders %}
          {% for order in today_orders %}
            <div class="order-box">
              <p><strong>Order ID:</strong> {{ order.id }}</p>
              <p><strong>Total:</strong> ₹{{ order.total }}</p>
              <p><strong>Token:</strong> {{ order.token_number }}</p>
              <p class="order-status">Status: <strong>{{ order.status|capitalize }}</strong></p>

              <div class="order-description">
                {% if order.status == 'paid' %}
                  <p class="info-text">Your order is paid. Awaiting admin confirmation.</p>
                {% elif order.status == 'confirmed' %}
                  <p class="info-text">Your order has been confirmed. Awaiting delivery.</p>
                {% elif order.status == 'delivered' %}
                  <p class="info-text">Your order has been delivered. Thank you!</p>
                {% elif order.status == 'cancelled' %}
                  <p class="info-text cancelled">This order was cancelled.</p>
                {% endif %}
              </div>

              <div class="food-details">
                <h4>Items:</h4>
                {% for item in order['items'] %}
                  <div class="food-item-entry">
                    <img src="{{ url_for('static', filename='uploads/' + item.image) }}" alt="{{ item.name }}">
                    <span>{{ item.name }} × {{ item.quantity }} (₹{{ item.price }} each)</span>
                  </div>
                {% endfor %}
              </div>

              <button class="qr-btn" onclick="showQR('{{ order.qr }}')">Show QR</button>
            </div>
          {% endfor %}
        {% else %}
          <p style="text-align:center;">No orders placed today.</p>
        {% endif %}
      </div>

      <!-- Past Orders -->
      <div class="order-section">
        <h3>Past Orders</h3>
        {% if past_orders %}
          {% for order in past_orders %}
            <div class="order-box">
              <p><strong>Order ID:</strong> {{ order.id }}</p>
              <p><strong>Total:</strong> ₹{{ order.total }}</p>
              <p><strong>Token:</strong> {{ order.token_number }}</p>
              {% if order.status == 'confirmed' and order.payment_status == 'paid' %}
    <span class="badge status-badge">Confirmed and Paid</span>
{% else %}
    <span class="badge status-badge">{{ order.status|capitalize }}</span>
{% endif %}

              <p>Ordered On: {{ order.created_at.strftime('%Y-%m-%d %H:%M') }}</p>

              <div class="food-details">
                <h4>Items:</h4>
                {% for item in order['items'] %}
                  <div class="food-item-entry">
                    <img src="{{ url_for('static', filename='uploads/' + item.image) }}" alt="{{ item.name }}">
                    <span>{{ item.name }} × {{ item.quantity }} (₹{{ item.price }} each)</span>
                  </div>
                {% endfor %}
              </div>

              <button class="qr-btn" onclick="showQR('{{ order.qr }}')">Show QR</button>
            </div>
          {% endfor %}
        {% else %}
          <p style="text-align:center;">No past orders.</p>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- QR Code Popup -->
  <div id="qr-popup" class="popup" style="display:none;">
    <div class="popup-content">
      <h3>Scan to Verify</h3>
      <img id="qr-img" src="" width="100%">
      <button onclick="closeQRPopup()">Close</button>
    </div>
  </div>


  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script> {# Add SweetAlert2 CDN #}
  <script>
    function showQR(base64) {
      document.getElementById('qr-img').src = 'data:image/png;base64,' + base64;
      document.getElementById('qr-popup').style.display = 'flex';
    }

    function closeQRPopup() {
      document.getElementById('qr-popup').style.display = 'none';
    }

    function cancelOrder(orderId) {
        Swal.fire({
            title: 'Are you sure?',
            text: "You won't be able to revert this!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Yes, cancel it!'
        }).then((result) => {
            if (result.isConfirmed) {
                fetch(`/order/cancel/${orderId}`, {
                    method: 'POST'
                }).then(res => {
                    if (res.ok) {
                        Swal.fire(
                            'Cancelled!',
                            'Your order has been cancelled.',
                            'success'
                        ).then(() => {
                            location.reload();
                        });
                    } else {
                        res.text().then(text => {
                            Swal.fire(
                                'Error!',
                                text || 'Failed to cancel order.',
                                'error'
                            );
                        });
                    }
                }).catch(error => {
                    console.error('Error cancelling order:', error);
                    Swal.fire(
                        'Error!',
                        'Network error or server issue.',
                        'error'
                    );
                });
            }
        });
    }

    function updateCountdown() {
        document.querySelectorAll('.cancel-timer').forEach(timerElement => {
            let secondsLeft = parseInt(timerElement.dataset.secondsLeft);

            if (secondsLeft > 0) {
                secondsLeft--;
                const minutes = Math.floor(secondsLeft / 60);
                const seconds = secondsLeft % 60;
                timerElement.innerText = `${minutes}:${String(seconds).padStart(2, '0')}`;
                timerElement.dataset.secondsLeft = secondsLeft;

                if (secondsLeft <= 0) {
                    const orderId = timerElement.dataset.orderId;
                    const cancelButton = document.getElementById(`cancel-btn-${orderId}`);
                    const cancelNote = document.getElementById(`cancel-note-${orderId}`);
                    if (cancelButton) {
                        cancelButton.disabled = true;
                        cancelButton.innerText = 'Cancellation Expired';
                    }
                    if (cancelNote) {
                        cancelNote.innerText = 'Cancellation window expired.';
                    }
                }
            }
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.cancel-timer').forEach(timerElement => {
            timerElement.dataset.orderId = timerElement.getAttribute('data-order-id');
        });
        setInterval(updateCountdown, 1000);
    });

  </script>
      <!-- MOBILE BOTTOM NAVIGATION -->
    <nav class="bottom-nav">
        <a href="{{ url_for('home') }}">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
            <span>Home</span>
        </a>
        <a href="{{ url_for('cart') }}">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></svg>
            <span>Cart</span>
        </a>
        <a href="{{ url_for('orders') }}">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
            <span>Orders</span>
        </a>
        <a href="{{ url_for('settings') }}">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15-.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
            <span>Settings</span>
        </a>
    </nav>
</div>
  </div>
</body>
</html>